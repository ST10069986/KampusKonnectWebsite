<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Student Modules</title>
    <style>
      /* Previous styles remain unchanged */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      body {
        background-color: #f0f2f5;
      }

      .navbar {
        background-color: #4285f4;
        padding: 1rem 2rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
      }

      .container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: #333;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: bold;
      }

      input,
      select {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      .module-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
      }

      .module-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
      }

      .module-item:last-child {
        border-bottom: none;
      }

      .module-checkbox {
        margin-right: 1rem;
      }

      .submit-btn {
        width: 100%;
        padding: 0.8rem;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
      }

      .submit-btn:hover {
        background-color: #3367d6;
      }

      .error-message {
        color: red;
        font-size: 0.8rem;
        margin-top: 0.2rem;
      }

      .success-message {
        color: green;
        font-size: 0.8rem;
        margin-top: 0.2rem;
      }

      .footer {
        background-color: #333;
        color: white;
        text-align: center;
        padding: 1rem;
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      #loadingIndicator {
        text-align: center;
        margin: 1rem 0;
        display: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">Kampus Konnect</div>
      <div id="studentInfo"></div>
    </nav>

    <div class="container">
      <h1>Add Modules</h1>
      <div id="loadingIndicator">Loading student information...</div>
      <form id="addModulesForm">
        <div class="form-group">
          <label for="studentId">Student ID</label>
          <input type="text" id="studentId" readonly />
        </div>

        <div class="form-group">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" readonly />
        </div>

        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" readonly />
        </div>

        <div class="form-group">
          <label for="qualification">Qualification</label>
          <input type="text" id="qualification" readonly />
        </div>

        <div class="form-group">
          <label for="semester">Semester</label>
          <select id="semester" required>
            <option value="">Select Semester</option>
            <option value="1">Semester 1</option>
            <option value="2">Semester 2</option>
          </select>
        </div>

        <div class="form-group">
          <label for="year">Year</label>
          <input
            type="number"
            id="year"
            required
            min="2024"
            max="2030"
            value="2024"
          />
        </div>

        <div class="form-group">
          <label>Available Modules</label>
          <div id="moduleList" class="module-list">
            <!-- Modules will be loaded here dynamically -->
          </div>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <button type="submit" class="submit-btn">Register Modules</button>
        <button
          type="button"
          class="submit-btn"
          onclick="window.location.href='StudentModulesDashboard.html'"
          style="margin-top: 0.5rem; background-color: #666"
        >
          Back to Modules Dashboard
        </button>
      </form>
    </div>

    <footer class="footer">
      <p>Â© 2024 KampusKonnect. All rights reserved.</p>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        setDoc,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBVGOh9N2kRbU8G6QRVtQsEr-6ANA4Gqjo",
        authDomain: "kampus-konnect-38932.firebaseapp.com",
        databaseURL: "https://kampus-konnect-38932-default-rtdb.firebaseio.com",
        projectId: "kampus-konnect-38932",
        storageBucket: "kampus-konnect-38932.appspot.com",
        messagingSenderId: "163800800971",
        appId: "1:163800800971:web:1a87e4ae7e9d8d30b8454e",
        measurementId: "G-4DV0GBX6YM",
      };

      // Initialize Firebase
      try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentStudentId = null;
        let currentQualificationId = null;
        let studentData = null;

        // Show loading indicator
        const loadingIndicator = document.getElementById("loadingIndicator");
        loadingIndicator.style.display = "block";

        // Check authentication and load student info
        onAuthStateChanged(auth, async (user) => {
          try {
            if (!user) {
              console.log("No user logged in, redirecting to login page");
              window.location.href = "login.html";
              return;
            }

            console.log("User logged in:", user.email);

            // Get student data
            const studentsRef = collection(db, "students");
            const q = query(studentsRef, where("email", "==", user.email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
              throw new Error("No student record found for this email address");
            }

            studentData = querySnapshot.docs[0].data();
            currentStudentId = studentData.studentId;

            // Populate student information fields
            document.getElementById("studentId").value = currentStudentId;
            document.getElementById("firstName").value = studentData.firstName;
            document.getElementById("lastName").value = studentData.lastName;

            console.log("Student info loaded:", currentStudentId);

            // Get student's qualification from CampusRegistration
            const campusRegRef = doc(
              db,
              "CampusRegistration",
              currentStudentId
            );
            const campusRegDoc = await getDoc(campusRegRef);

            if (!campusRegDoc.exists()) {
              throw new Error("No campus registration found for this student");
            }

            const regData = campusRegDoc.data();
            currentQualificationId = regData.qualificationId;
            console.log("Qualification ID loaded:", currentQualificationId);

            // Get qualification details
            const qualificationRef = doc(
              db,
              "qualifications",
              currentQualificationId
            );
            const qualificationDoc = await getDoc(qualificationRef);

            if (!qualificationDoc.exists()) {
              throw new Error("Qualification not found");
            }

            const qualificationData = qualificationDoc.data();
            document.getElementById("qualification").value =
              qualificationData.name;
            console.log("Qualification loaded:", qualificationData.name);

            // Load modules for this qualification
            await loadQualificationModules(qualificationData);
          } catch (error) {
            console.error("Error in authentication process:", error);
            document.getElementById(
              "errorMessage"
            ).textContent = `Error: ${error.message}`;
          } finally {
            loadingIndicator.style.display = "none";
          }
        });

        async function loadQualificationModules(qualificationData) {
          try {
            const moduleList = document.getElementById("moduleList");
            moduleList.innerHTML = "<p>Loading modules...</p>";

            const qualificationRef = doc(
              db,
              "qualifications",
              currentQualificationId
            );
            const qualificationDoc = await getDoc(qualificationRef);

            if (!qualificationDoc.exists()) {
              throw new Error("Qualification not found");
            }

            const qualificationFields = qualificationDoc.data();
            const moduleFields = Object.entries(qualificationFields).filter(
              ([key]) => key.match(/[A-Z]+\d{4}/)
            );

            if (moduleFields.length === 0) {
              moduleList.innerHTML =
                "<p>No modules available for this qualification.</p>";
              return;
            }

            moduleList.innerHTML = ""; // Clear loading message

            for (const [moduleCode, moduleName] of moduleFields) {
              const moduleItem = document.createElement("div");
              moduleItem.classList.add("module-item");
              moduleItem.innerHTML = `
                <input type="checkbox" class="module-checkbox" id="${moduleCode}" value="${moduleCode}">
                <label for="${moduleCode}">${moduleCode} - ${moduleName}</label>
              `;
              moduleList.appendChild(moduleItem);
            }
          } catch (error) {
            console.error("Error loading modules:", error);
            document.getElementById(
              "errorMessage"
            ).textContent = `Error loading modules: ${error.message}`;
            moduleList.innerHTML =
              "<p>Error loading modules. Please try refreshing the page.</p>";
          }
        }

        // Modified module registration handler with new data structure
        document
          .getElementById("addModulesForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = "Registering...";

            try {
              const selectedModules = Array.from(
                document.querySelectorAll(".module-checkbox:checked")
              ).map((cb) => cb.value);

              const semester = document.getElementById("semester").value;
              const year = document.getElementById("year").value;

              if (!semester || !year) {
                throw new Error("Please select both semester and year.");
              }

              if (selectedModules.length === 0) {
                throw new Error("Please select at least one module.");
              }

              // Get the qualification document to access module names
              const qualificationRef = doc(
                db,
                "qualifications",
                currentQualificationId
              );
              const qualificationDoc = await getDoc(qualificationRef);
              const qualificationData = qualificationDoc.data();

              // Create array of selected modules with their names
              const moduleArray = selectedModules.map((moduleCode) => ({
                moduleCode: moduleCode,
                moduleName: qualificationData[moduleCode],
              }));

              // Create the student modules document
              const studentModulesRef = doc(
                db,
                "StudentModules",
                currentStudentId
              );

              // Get existing registrations if any
              const existingDoc = await getDoc(studentModulesRef);
              const existingRegistrations = existingDoc.exists()
                ? existingDoc.data().registrations || []
                : [];

              // Check for duplicate registrations
              const newRegistration = {
                semester: semester,
                year: year,
                modules: moduleArray,
                timestamp: new Date().toISOString(),
              };

              // Check if this semester and year combination already exists
              const duplicateRegistration = existingRegistrations.some(
                (reg) => reg.semester === semester && reg.year === year
              );

              if (duplicateRegistration) {
                throw new Error(
                  `You already have registrations for Semester ${semester}, ${year}`
                );
              }

              // Store all student information and modules
              await setDoc(studentModulesRef, {
                studentId: currentStudentId,
                firstName: studentData.firstName,
                lastName: studentData.lastName,
                qualification: document.getElementById("qualification").value,
                registrations: [...existingRegistrations, newRegistration],
              });

              document.getElementById("successMessage").textContent =
                "Modules registered successfully!";
              document.getElementById("errorMessage").textContent = "";

              // Redirect after successful registration
              setTimeout(() => {
                window.location.href = "StudentModulesDashboard.html";
              }, 2000);
            } catch (error) {
              console.error("Registration error:", error);
              document.getElementById(
                "errorMessage"
              ).textContent = `Registration failed: ${error.message}`;
            } finally {
              submitBtn.disabled = false;
              submitBtn.textContent = "Register Modules";
            }
          });
      } catch (error) {
        console.error("Firebase initialization error:", error);
        document.getElementById("errorMessage").textContent =
          "Error initializing application. Please try refreshing the page.";
      }
    </script>
  </body>
</html>
